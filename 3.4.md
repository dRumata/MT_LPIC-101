# 3. Команды GNU и UNIX

## 3.4 Потоки, пайпы и перенаправление (103.4 Use streams, pipes and redirects)

### Вопросы для самопроверки


1. Как называется стандартный канал, перенаправляемый командой `date 1> now.txt`?
    <details>
    <summary>Вариант ответа</summary>

    Стандартный вывод или **stdout**
    
    </details>
<br> 


2. При попытке перезаписать файл с помощью перенаправления пользователь получает ошибку, сообщающую, что опция **noclobber** включена. Как можно отключить опцию **noclobber** для текущей сессии?
    <details>
    <summary>Вариант ответа</summary>

    `set +C` или `set +o noclobber
    
    </details>
<br> 


3. Каков будет результат выполнения команды `cat <<.>/dev/stdout`?
    <details>
    <summary>Вариант ответа</summary>

    Bash перейдет в режим ввода Heredoc и выйдет из него, когда в строке появится точка. Набранный текст будет перенаправлен в **stdout** (выведен на экран).
    
    </details>
<br> 


4. Команда `cat /proc/cpu_info` выводит сообщение об ошибке, поскольку **/proc/cpu_info** не существует. Команда `cat /proc/cpu_info 2>1` перенаправляет сообщение об ошибке куда?
    <details>
    <summary>Вариант ответа</summary>

    К файлу с именем **1** в текущем каталоге.
    
    </details>
<br>    


5. Будет ли по-прежнему возможно отбрасывать содержимое, отправляемое в **/dev/null**, если для текущего сеанса оболочки включена опция **noclobber**?
    <details>
    <summary>Вариант ответа</summary>

    Да. **/dev/null** - это специальный файл, на который не действует **noclobber**.
    
    </details>
<br> 


6. Как, не используя `echo`, перенаправить содержимое переменной `$USER` на **stdin** команды `sha1sum`?
    <details>
    <summary>Вариант ответа</summary>

    ```sh
    $ sha1sum <<<$USER
    ```
    
    </details>
<br> 


7. Ядро Linux хранит в каталоге **/proc/PID/fd/** символические ссылки на каждый файл, открытый процессом, где **PID** - идентификационный номер соответствующего процесса. Как системный администратор может использовать этот каталог для проверки местоположения лог-файлов, открытых **nginx**, если предположить, что его **PID** равен **1234**?
    <details>
    <summary>Вариант ответа</summary>

    Выполнив команду 
    ```sh
    ls -l /proc/1234/fd
    ```
    вы увидите цели каждой символической ссылки в каталоге.
    
    </details>
<br> 







---
### Практические задания

1. Помимо текстовых файлов, команда `cat` может работать и с двоичными данными, например, пересылать содержимое блочного устройства в файл. 

1.1 Используя перенаправление, отправьте содержимое устройства **/dev/sda1** в файл **sdc.img** в текущем каталоге
```sh
sudo cat /dev/sdc > sdc.img
```

---
2. Арифметические вычисления можно производить, используя только встроенные команды оболочки, но для вычислений с плавающей точкой требуются специальные программы, например, `bc` (basic calculator). С помощью `bc` можно даже задать количество знаков после запятой, используя параметр **scale**. Однако `bc` принимает операции только через стандартный ввод, который обычно вводится в интерактивном режиме. 

2.1 Используя строку Here, передайте на стандартный вход `bc` операцию с плавающей запятой `scale=6; 3.14/3`
```sh
bc <<<"scale=6; 3.14/3"
```

---
3.  Удобно сохранять дату выполнения действий, выполняемых автоматическими сценариями. Команда `date +%Y-%m-%d` показывает текущую дату в формате год-месяц-день. 

3.1 C помощью подстановки команд сохраните вывод такой команды в переменной оболочки с именем **TODAY**
```sh
TODAY=`date +%Y-%m-%d`
```

или
```sh
TODAY=$(date +%Y-%m-%d)
```
```sh
echo $TODAY
```

3.2 Используя команду `echo`, передайте содержимое переменной **TODAY** на стандартный вход команды `sed s/-/./g`?
```sh
echo $TODAY | sed s/-/./g
```

3.3  Используйте вывод команды `date +%Y-%m-%d` в качестве строки Here для команды `sed s/-/./g`
```sh
sed s/-/./g <<< `date +%Y-%m-%d`
```
или
```sh
sed s/-/./g <<< $(date +%Y-%m-%d)
```

---
4.  Команда `convert image.jpeg -resize 25% small/image.jpeg` создает уменьшенную версию **image.jpeg** и помещает полученное изображение в файл с аналогичным именем в подкаталоге **small**. 


Как, используя `xargs`, можно выполнить ту же команду для каждого изображения, перечисленного в файле **filelist.txt**?
```sh
$ xargs -I IMG convert IMG -resize 25% small/IMG < filelist.txt
```
или
```sh
$ cat filelist.txt | xargs -I IMG convert IMG -resize 25% small/IMG
```

1.  Простая программа резервного копирования периодически создает образ раздела **/dev/sda1** командой `dd </dev/sda1 > sda1.img`. Для последующей проверки целостности данных программа также генерирует SHA1-хэш файла командой `sha1sum < sda1.img > sda1.sha1`. Каким образом можно объединить эти две команды в одну, добавив `pipes` и команду `tee`?
```sh
dd < /dev/sda1 | tee sda1.img | sha1sum > sda1.sha1
```

1.  Команда `tar` используется для архивирования множества файлов в один файл с сохранением структуры каталогов.

Опция `-T` позволяет указать файл, содержащий пути, по которым будет производиться архивация. Например, `find /etc -type f | tar -cJ -f /srv/backup/etc.tar.xz -T` - создает сжатый tar-файл **etc.tar.xz** из списка, предоставленного командой `find` (опция `-T` - указывает на стандартный ввод в качестве списка путей). Чтобы избежать возможных ошибок разбора, связанных с тем, что пути содержат пробелы, какие опции команд должны присутствовать в `find` и `tar`?

Опции **-print0** и **--null**:
```sh
$ find /etc -type f -print0 | tar -cJ -f /srv/backup/etc.tar.xz --null -T -
```

16. Вместо того чтобы открывать новый удаленный сеанс оболочки, команда ssh может просто выполнить команду, указанную в качестве ее аргумента: `ssh user@storage "remote command"`. Учитывая, что `ssh` также позволяет перенаправлять стандартный вывод локальной программы на стандартный ввод удаленной программы, как с помощью `ssh` передать локальный файл с именем **etc.tar.gz** в файл **/srv/backup/etc.tar.gz** на сервер **user@storage**?
```sh
$ cat etc.tar.gz | ssh user@storage "cat > /srv/backup/etc.tar.gz"
```
или
```sh
$ ssh user@storage "cat > /srv/backup/etc.tar.gz" < etc.tar.gz
```