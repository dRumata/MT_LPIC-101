## Практическая работа 20. 
## Загрузка системы.

> Соответствие LPI101: (101.2 Boot the system)

### Вопросы для самопроверки

1. На машине, оснащенной микропрограммой **BIOS**, где находится двоичный файл начальной загрузки? 
   <details>
   <summary>Вариант ответа</summary>
   В **MBR** первого устройства хранения данных, как определено в утилите настройки **BIOS**.
    </details>
<br>

2. Микропрограмма **UEFI** поддерживает расширенные возможности, предоставляемые внешними программами, называемыми приложениями **EFI**. Однако эти приложения имеют свое собственное специальное расположение. Где в системе могут располагаться приложения **EFI**? 

   <details>
   <summary>Вариант ответа</summary>
   Приложения **EFI** хранятся в системном разделе **EFI (ESP)**, расположенном на любом доступном блоке памяти с совместимой файловой системой (обычно это файловая система **FAT32**).
    </details>
<br>   


3. Если на машине установлено более одной операционной системы, загрузчик представит список операционных систем для выбора. Однако вновь установленная операционная система может перезаписать **MBR** жесткого диска, стереть первый этап загрузчика и сделать недоступной другую операционную систему. Почему этого не происходит на машине с микропрограммой **UEFI**? 

   <details>
   <summary>Вариант ответа</summary>
   Машины с **UEFI** не используют **MBR** жесткого диска для хранения первого этапа загрузчика.
    </details>
<br>      


4. К каким последствиям может привести установка пользовательского ядра без предоставления соответствующего образа **initramfs**? 

   <details>
   <summary>Вариант ответа</summary>
   Корневая файловая система может быть недоступна, если ее тип был скомпилирован как внешний модуль ядра.
    </details>
<br>     

5. Загрузчики позволяют передавать пользовательские параметры ядра перед его загрузкой. Предположим, что система не может загрузиться из-за неверно указанного расположения корневой файловой системы. Как передать ядру в качестве параметра правильную корневую файловую систему, расположенную по адресу `/dev/sda3`? 

   <details>
   <summary>Вариант ответа</summary>
   Необходимо использовать параметр `root`, например 
   ```
   root=/dev/sda3
   ```
    </details>
<br>     

6. Процесс загрузки Linux-машины заканчивается следующим сообщением: 
   ```
   ALERT! /dev/sda3 does not exist. Dropping to a shell!
   ```  
   Какова вероятная причина этой проблемы? 

   <details>
   <summary>Вариант ответа</summary>
   Ядро не смогло найти устройство `/dev/sda3`, объявленное корневой файловой системой.
   ```
   root=/dev/sda3
   ```
    </details>
<br>   

---
### Практические задания


1. В этом упражнении вы будете загружать RHEL вручную. Выполните следующие действия:

1.1. Загрузите систему. Когда вы увидите следующую строку в верхней части экрана, нажмите любую клавишу, чтобы получить доступ к меню **GRUB2**:
Выбранная запись будет запущена автоматически через 5 секунд.

1.2. Нажмите **```c```** для вызова интерфейса командной строки на основе GRUB. Вы должны увидеть подсказку **grub>**.

1.3. Загрузите модуль **LVM**, введя следующую команду:

```bash
grub> insmod lvm
```

1.4. Получите список всех разделов и логических томов:

```bash
grub> ls
```

1.5. Определите **корневой раздел**. Это может быть названо как-то вроде (**lvm/rhel-root**). Возможно, вам придется использовать некоторые методы проб и ошибок, чтобы выяснить это (например, попытавшись отобразить файл /etc/stab из всех названий устройств, ранее перечисленных GRUB 2).

```bash
grub> cat (lvm/fedora_fedora-root)/etc/fstab
```

1.6. Установите переменную **root** для устройства, которое вы определили как устройство, содержащее корневую файловую систему:

```bash
grub> set root=(lvm/fedora_fedora-root)
```

1.7. Введите команду **linux**, которая определяет ядро и раздел корневого каталога.
Да, это длинная строка; однако вы можете использовать завершение команды (нажмите клавишу TAB), чтобы ускорить выполнение. Кроме того, единственными важными частями строки являются файл ядра и расположение корневого каталога верхнего уровня. 

```bash
linux (hd0,gpt2)/vmlinuz-5.10.0-123.17.x86_64 root=/dev/mapper/rhel-root
```

1.8. Введите команду **initrd**, которая задает начальную команду RAM disk и местоположение файла. Опять же, вы можете использовать клавишу TAB для завершения имени файла. 

```bash
initrd (hd0,gpt2)/initramfs-5.10.0-123.e17.x86_64.img
```

1.9. Теперь введите команду **boot**. Если эта команда выполнена успешно, Linux теперь должен загрузить выбранное ядро и начальный диск RAM точно так же, как если бы вы выбрали этот параметр в меню конфигурации GRUB2.

---
2. Журнал инициализации имеет длину в сотни строк, поэтому вывод команды `dmesg` часто передается команде `pager` - например, команде `less` - для облегчения чтения. Используйте опцию `-H`, которая автоматически разбивает вывод на страницы, избавляя от необходимости явно использовать команду `pager`. Команды `dmesg -H` или `dmesg --human` по умолчанию включают пейджер.

2.1. Просомотрите журнал инициализации
```sh
dmesg
```

2.2. Повторите предыдущие дейстиве но с опцией `--human`
```sh
dmesg -H
```

2.3. Пролистайте постранично файл и найдите строки содержащие сообщения от systemd

2.4. Убедитесь что ОС определила виртуализацию от vmware. Вы должны увидеть что-то подобное:
```console
[  +0.000003] systemd[1]: Detected virtualization vmware.
[  +0.000002] systemd[1]: Detected architecture x86-64.
```
2.5. Пролистайте постранично файл и найдите строки содержащие сообщения о подключеных дисках, убедитесь, что обнаружены два диска объемом 24 и 16 Гигабайт. Вы должны увидеть что-то подобное:
```console
[  +0.002440] sd 2:0:0:0: Attached scsi generic sg1 type 0
[  +0.000057] sd 2:0:0:0: [sda] 50331648 512-byte logical blocks: (25.8 GB/24.0 GiB)
[  +0.000041] sd 2:0:0:0: [sda] Write Protect is off
[  +0.000001] sd 2:0:0:0: [sda] Mode Sense: 31 00 00 00
[  +0.000020] sd 2:0:0:0: [sda] Cache data unavailable
[  +0.000001] sd 2:0:0:0: [sda] Assuming drive cache: write through
[  +0.000060] sd 2:0:1:0: Attached scsi generic sg2 type 0
[  +0.000042] sd 2:0:1:0: [sdb] 33554432 512-byte logical blocks: (17.2 GB/16.0 GiB)
[  +0.000016] sd 2:0:1:0: [sdb] Write Protect is off
[  +0.000001] sd 2:0:1:0: [sdb] Mode Sense: 31 00 00 00
[  +0.000016] sd 2:0:1:0: [sdb] Cache data unavailable
[  +0.000001] sd 2:0:1:0: [sdb] Assuming drive cache: write through
[  +0.000812] sd 2:0:1:0: [sdb] Attached SCSI disk
[  +0.001197]  sda: sda1 sda2 sda3
[  +0.000195] sd 2:0:0:0: [sda] Attached SCSI disk
```

2.6. Попытайтесь определить тип файловой системы
```sh
[student@fedora ~]$ dmesg |grep 'sda'
```
Вероятнее всего вы увидете информацию о монтировании XFS:
```console
[    1.436215] sd 2:0:0:0: [sda] 50331648 512-byte logical blocks: (25.8 GB/24.0 GiB)
[    1.436256] sd 2:0:0:0: [sda] Write Protect is off
[    1.436257] sd 2:0:0:0: [sda] Mode Sense: 31 00 00 00
[    1.436277] sd 2:0:0:0: [sda] Cache data unavailable
[    1.436278] sd 2:0:0:0: [sda] Assuming drive cache: write through
[    1.438423]  sda: sda1 sda2 sda3
[    1.438618] sd 2:0:0:0: [sda] Attached SCSI disk
[    4.548453] XFS (sda2): Mounting V5 Filesystem 6b889288-6ed5-4b71-9b51-f0e8842dec10
[    4.566886] XFS (sda2): Ending clean mount
```

---

3. Жесткий диск, содержащий всю файловую систему выключенной машины, был извлечен и подключен к работающей машине в качестве дополнительного диска. Если предположить, что его точкой монтирования является **`/mnt/hd`**, то как с помощью `journalctl` можно проверить содержимое файлов журнала, расположенных по адресу **`/mnt/hd/var/log/journal/`**? 


3.1 Убедитесь, в каталоге /mnt/hd доступны файлы журнала
```sh
[student@fedora ~]$ tree /mnt/hd/
```
```console
/mnt/hd/
└── var
    └── log
        └── journal
            └── 81d8b756a65743c28e1f4c97b37eadab
                ├── system@000603ac9b6c8b09-49f819dc3171b436.journal~
                ├── system@0fcb4bf291794b0ca44affda86bae74c-0000000000000001-000603ab9c9cdb42.journal
                ├── system@0fcb4bf291794b0ca44affda86bae74c-0000000000000935-000603ab9d3fe747.journal
                ├── system@0fcb4bf291794b0ca44affda86bae74c-00000000000051b7-000603ac9b6ca1e0.journal
                ├── system@0fcb4bf291794b0ca44affda86bae74c-0000000000006711-000603aca1da1b13.journal
                ├── system@0fcb4bf291794b0ca44affda86bae74c-0000000000006eb3-000603aca26b63e7.journal
                ├── system@0fcb4bf291794b0ca44affda86bae74c-00000000000072d4-000603ba6f261844.journal
                ├── system@0fcb4bf291794b0ca44affda86bae74c-0000000000007c33-000603ba8e54defa.journal
                ├── system.journal
                ├── user-1000@000603aca26bbd32-223b60787bbe3c24.journal~
                ├── user-1000@69456388693b4c53a5cc75fca27f7107-0000000000006ee1-000603aca8aa8699.journal
                ├── user-1000@e4e8965eabb04415aa66d30b3b8ceb97-0000000000000a7f-000603abb2fd019f.journal
                └── user-1000.journal

5 directories, 13 files
```
Если похожая структура отсутствует, запустите скрипт 
```sh
sudo ~/bin/lab1.2.sh
```
и снова проверьте наличие файлов.

3.2 С помощью команды просмотрите журнал на подключенном диске 
```sh
journalctl -D /mnt/hd/var/log/journal
``` 
или 
```sh
journalctl --directory=/mnt/hd/var/log/journal
```
3.3. Найдите сообщения об ошибках в журнале
```sh
sudo journalctl -D /mnt/hd/var/log/journal/|grep error
```
Вы должны увидеть что-то подобное:
```console
Aug 24 18:06:30 fedora.test.local dnf-3[774]: error: libselinux: type 0: Regex version mismatch, expected: 10.40 2022-04-14 actual: 10.42 2022-12-11
Aug 24 18:07:49 fedora.test.local dnf-3[774]:   Cleanup          : libgpg-error-1.46-1.fc37.x86_64                  3084/3439
Aug 24 18:10:14 fedora.test.local dnf-3[774]:   Verifying        : libgpg-error-1.47-1.fc38.x86_64                  2758/3439
Aug 24 18:10:14 fedora.test.local dnf-3[774]:   Verifying        : libgpg-error-1.46-1.fc37.x86_64                  2759/3439
Aug 24 18:10:33 fedora.test.local dnf-3[774]:   libgpg-error-1.47-1.fc38.x86_64
Aug 24 18:10:49 fedora.test.local udisksd[800]: Error probing device: Error sending ATA command IDENTIFY PACKET DEVICE to '/dev/sr0': ATA command failed: error=0x01 count=0x02 status=0x50 (g-io-error-quark, 0)
```