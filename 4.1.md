# 4. Устройства, файловые системы, FHS
## 4.1 Создание разделов и файловых систем (104.1 Create partitions and filesystems)

### Вопросы для самопроверки

1. Какую схему разметки следует использовать для разбиения жесткого диска объемом 3 ТБ на три раздела по 1 ГБ? Почему?
    <details>
    <summary>Вариант ответа</summary>

    GPT, поскольку MBR поддерживает не более 2 ТБ жестких дисков.
    
    </details>
<br> 
   


2. Как в программе `gdisk` узнать, сколько места доступно на диске?
    <details>
    <summary>Вариант ответа</summary>

    С помощью команды `p` (print). Общее количество свободного места будет показано в последней строке информации перед самой таблицей разделов.
    
    </details>
<br> 
   


3. Какой командой можно создать на устройстве **/dev/sdc1** файловую систему **ext3** с меткой **MyDisk** и случайным **UUID**, предварительно проверив ее на наличие поврежденных блоков?
    <details>
    <summary>Вариант ответа</summary>

    Команда будет выглядеть так: 
    ```sh
    mkfs.ext3 -c -L MyDisk -U random /dev/sdc1
    ```
    Также вместо `mkfs.ext3` можно использовать команду 
    ```sh
    mke2fs -t ext3
    ```
    
    </details>
<br> 
   


4. Используя `parted`, какой командой можно создать раздел **ext4** размером 300 МБ, начиная с 500 МБ на диске?
    <details>
    <summary>Вариант ответа</summary>

    Используйте команду 
    ```sh
    mkpart primary ext4 500m 800m
    ``` 
    Помните, что файловую систему придется создавать с помощью **mkfs.ext4**, поскольку parted этого не делает.
    
    </details>
<br> 
   

5. Представьте, что у вас есть 2 раздела, один на **/dev/sda1**, другой на **/dev/sdb1**, оба размером 20 ГБ. Как их использовать в одной файловой системе **Btrfs** таким образом, чтобы содержимое одного раздела автоматически зеркалировалось на другом, как в **RAID1**? Какого размера будет файловая система?

    <details>
    <summary>Вариант ответа</summary>

    Используйте команду 
    ```sh
    mkfs.btrfs /dev/sda1 /dev/sdb1 -m raid1
    ```
    Результирующая файловая система будет иметь размер 20 ГБ, так как один раздел является просто зеркальным отображением другого.
    
    </details>
<br> 


6. Рассмотрим диск объемом 2 Гбайт с таблицей разделов MBR и следующей разметкой:

```console
Disk /dev/sdb: 1.9 GiB, 1998631936 bytes, 3903578 sectors
Disk model: DataTraveler 2.0
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos
Disk identifier: 0x31a83a48
Device Boot Start End Sectors Size Id Type
/dev/sdb1 2048 1050623 1048576 512M 83 Linux
/dev/sdb3 2099200 3147775 1048576 512M 83 Linux
```

Можно ли создать на нем раздел размером 600 МБ? Почему?

<details>
<summary>Вариант ответа</summary>

Невозможно, поскольку не хватает свободного места. Первым признаком того, что что-то "не так", является список устройств: у вас есть **/dev/sdb1** и **/dev/sdb3**, но нет **/dev/sdb2**. Значит, чего-то не хватает. Затем нужно посмотреть, где заканчивается один раздел и начинается другой. Первый раздел заканчивается на секторе 1050623, а второй начинается на 2099200. Таким образом, "разрыв" составляет 1048577 секторов. При 512 байтах на сектор это составляет 536.871.424 байта. Если разделить это на 1024, то получится 524,288 килобайта. Снова делим на 1024 и получаем... 512 МБ. Это и есть размер "зазора".
    
Если диск имеет объем 2 Гбайт, то после раздела 3 мы получим максимум еще на 512 Мбайт. Даже если в общей сложности у нас нераспределено около 1 ГБ, самый большой смежный блок составляет 512 МБ. Значит, для раздела размером 600 Мбайт места нет.
    
</details>
<br> 
   
 
7. На диске по адресу **/dev/sdc** имеется первый раздел размером 1 ГБ, содержащий файловую систему **ext4** с файлами размером 241 МБ. Как с помощью `parted` уменьшить этот раздел, чтобы на нем осталось достаточно места для файлов?
    <details>
    <summary>Вариант ответа</summary>

    Эта операция состоит из нескольких частей. Сначала нужно уменьшить файловую систему с помощью `resize2fs`. Вместо того чтобы указывать новый размер напрямую, можно использовать параметр `-M`, чтобы он был просто "достаточно большим". Итак:
    ```sh
    resize2fs -M /dev/sdc1
    ```
    Затем с помощью `resizepart` изменяем размер самого раздела с помощью `parted`. Поскольку это первый раздел, можно считать, что он начинается с нуля и заканчивается 241 МБ. Поэтому команда выглядит следующим образом 
    ```sh
    resizepart 1 241M
    ```
    
    </details>
<br> 
   


8. Представьте, что у вас есть диск по адресу **/dev/sdb**, и вы хотите создать в его начале раздел размером 1 ГБ. Поэтому, используя `parted`, вы создаете раздел с помощью команды `mkpart primary linux-swap 0 1024M`. Затем с помощью команды `swapon /dev/sdb1` вы включаете своп на этом разделе, но получаете следующее сообщение об ошибке:
```console
swapon: /dev/sdb1: read swap header failed
```

Что произошло?

<details>
<summary>Вариант ответа</summary>

Вы создали раздел правильного типа (linux-swap), но помните, что `mkpart` не создает файловую систему. Вы забыли установить раздел в качестве пространства подкачки с помощью mkswap, прежде чем использовать его.

</details>
<br> 
   
9. Представьте, что на диске **/dev/sda3** имеется неиспользуемый раздел размером 4 ГБ. Какова будет последовательность действий при использовании `fdisk` для превращения его в активный раздел подкачки?
    <details>
    <summary>Вариант ответа</summary>

    Сначала измените тип раздела на **"Linux Swap" (82)**, запишите изменения на диск и выйдите из системы. Затем с помощью `mkswap` установите раздел в качестве области подкачки. Затем с помощью `swapon` включите его.
    
    </details>
<br> 
   


---
### Практические задания

1. Создание разделов MBR с помощью fdisk

1.1. Откройте коммандную оболочку и убедитесь, что у вас есть доступные для форматирования свободные диски с помощью комманды `lsblk`
```bash
lsblk
```
```bash
NAME                     MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS
sda                        8:0    0    20G  0 disk
├─sda1                     8:1    0     1M  0 part
├─sda2                     8:2    0     1G  0 part /boot
└─sda3                     8:3    0  18,4G  0 part
  ├─fedora-root 253:0    0    10G  0 lvm  /
  ├─fedora-swap 253:1    0     1G  0 lvm  [SWAP]
  ├─fedora-srv  253:2    0     1G  0 lvm  /srv
  ├─fedora-tmp  253:3    0   400M  0 lvm  /tmp
  ├─fedora-home 253:4    0     1G  0 lvm  /home
  └─fedora-var  253:5    0     5G  0 lvm  /var
sdb                        8:16   0     5G  0 disk
sr0                       11:0    1 665,1M  0 rom
zram0                    252:0    0   3,8G  0 disk [SWAP]
```

1.2. Выполните команду `fdisk`. Эта команда должна в качестве аргумента указать имя дискового устройства, на котором вы хотите создать раздел. В этом упражнении используется **/dev/sda**. При необходимости измените это в соответствии с вашим оборудованием.

```bash
sudo fdisk /dev/sdb
```
```console
[sudo] пароль для student:

Добро пожаловать в fdisk (util-linux 2.38.1).
Изменения останутся только в памяти до тех пор, пока вы не решите записать их.
Будьте внимательны, используя команду write.

Устройство не содержит стандартной таблицы разделов.
Создана новая метка DOS с идентификатором 0xcdd89ca7.

Команда (m для справки)
```

1.3. Прежде чем что-либо делать, рекомендуется проверить, сколько у вас свободного места на диске. Нажмите `p`, чтобы увидеть обзор текущего распределения диска:

```bash
Команда (m для справки): p
Диск /dev/sdb: 5 GiB, 5368709120 байт, 10485760 секторов
Disk model: Virtual disk
Единицы: секторов по 1 * 512 = 512 байт
Размер сектора (логический/физический): 512 байт / 512 байт
Размер I/O (минимальный/оптимальный): 512 байт / 512 байт
Тип метки диска: dos
Идентификатор диска: 0xcdd89ca7
```

1.4. Введите `n`, чтобы добавить новый раздел:

1.5. Укажите первый сектор на диске, с которого будет начинаться новый раздел. По умолчанию предлагается первый доступный сектор, поэтому нажмите `Enter` для подтверждения.

1.6. Укажите последний сектор, на котором будет заканчиваться раздел. Введите `+number(K,M,G)`, чтобы указать размер, который вы хотите назначить для раздела, в KiB, MiB или GiB. Введите `+1G`, чтобы сделать этот раздел размером **1 ГиБ**.

```console
Команда (m для справки): n
Тип раздела
   p   основной (0 primary, 0 extended, 4 free)
   e   расширенный (контейнер для логических разделов)
Выберите (по умолчанию - p):p
Номер раздела (1-4, default 1): 1
Первый сектор (2048-10485759, default 2048):
Last sector, +/-sectors or +/-size{K,M,G,T,P} (2048-10485759, default 10485759): +1GiB

Создан новый раздел 1 с типом 'Linux' и размером 1 GiB.
```

1.7. Если вас устраивают изменения, нажмите `w`, чтобы записать их на диск и выйти из `fdisk`.

1.8. Проверьте наличие нового раздела с помощью комманды `lsblk`

```bash
lsblk
```
```bash
NAME                     MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS
sda                        8:0    0    20G  0 disk
├─sda1                     8:1    0     1M  0 part
├─sda2                     8:2    0     1G  0 part /boot
└─sda3                     8:3    0  18,4G  0 part
  ├─fedora-root 253:0    0    10G  0 lvm  /
  ├─fedora-swap 253:1    0     1G  0 lvm  [SWAP]
  ├─fedora-srv  253:2    0     1G  0 lvm  /srv
  ├─fedora-tmp  253:3    0   400M  0 lvm  /tmp
  ├─fedora-home 253:4    0     1G  0 lvm  /home
  └─fedora-var  253:5    0     5G  0 lvm  /var
sdb                        8:16   0     5G  0 disk
└─sdb1                     8:17   0     1G  0 part
sr0                       11:0    1 665,1M  0 rom
zram0                    252:0    0   3,8G  0 disk [SWAP]
```

---
2. Создание разделов GPT с помощью gdisk

**Предупреждение:** *Не используйте `gdisk` на диске, отформатированном с помощью fdisk и уже содержащем разделы `fdisk`. `gdisk` обнаружит наличие **MBR** и преобразует его в **GPT**
```console
GPT fdisk (gdisk) version 1.0.9

Partition table scan:
  MBR: MBR only
  BSD: not present
  APM: not present
  GPT: not present


***************************************************************
Found invalid GPT and valid MBR; converting MBR to GPT format
in memory. THIS OPERATION IS POTENTIALLY DESTRUCTIVE! Exit by
typing 'q' if you don't want to convert your MBR partitions
to GPT format!
***************************************************************


Command (? for help):
```

2.1. Создайте резервную копию **MBR** с помощью команды `dd`. Использование этой команды позволяет вам создать резервную копию первого мегабайта необработанных блоков и записать ее в файл. Этот файл позволяет вам легко вернуться к ситуации, которая существовала в начале этого упражнения, поскольку команда создает резервную копию **MBR** и всех соответствующих метаданных на диске.
```bash
sudo dd if=/dev/sdb of=/root/mbrbackup bs=1M count=1
```
```console
[sudo] пароль для student:
1+0 records in
1+0 records out
1048576 bytes (1,0 MB, 1,0 MiB) copied, 0,00442375 s, 237 MB/s
```

2.2. Чтобы создать раздел с помощью `gdisk`. (Замените `/dev/sdb` на точное имя устройства, используемое на вашем компьютере.) `gdisk` попытается определить текущую структуру диска и, если ничего не обнаружит, создаст таблицу разделов **GPT** и связанную структуру диска. Введите `n`, чтобы войти в новый раздел. Вы можете выбрать любой номер раздела от **1** до **128**, но будет разумно принять предложенный номер раздела по умолчанию.
```bash
sudo gdisk /dev/sdb
```
```console
GPT fdisk (gdisk) version 1.0.9

Partition table scan:
  MBR: MBR only
  BSD: not present
  APM: not present
  GPT: not present


***************************************************************
Found invalid GPT and valid MBR; converting MBR to GPT format
in memory. THIS OPERATION IS POTENTIALLY DESTRUCTIVE! Exit by
typing 'q' if you don't want to convert your MBR partitions
to GPT format!
***************************************************************


Command (? for help):

Command (? for help): n
Partition number (2-128, default 2): 2
First sector (34-10485726, default = 2099200) or {+-}size{KMGTP}:
Last sector (2099200-10485726, default = 10483711) or {+-}size{KMGTP}: +1500MiB
Current type is 8300 (Linux filesystem)
Hex code or GUID (L to show codes, Enter = 8300):
Changed type of partition to 'Linux filesystem'
```

2.3. Раздел создан (но еще не записан на диск). Нажмите `p`, чтобы отобразить обзор, который позволит вам убедиться, что это действительно то, что вы хотите использовать.

```console
Command (? for help): p
Disk /dev/sdb: 10485760 sectors, 5.0 GiB
Model: Virtual disk
Sector size (logical/physical): 512/512 bytes
Disk identifier (GUID): CDDB5967-DA92-45EE-A0D7-11C78784EBAE
Partition table holds up to 128 entries
Main partition table begins at sector 2 and ends at sector 33
First usable sector is 34, last usable sector is 10485726
Partitions will be aligned on 2048-sector boundaries
Total free space is 5316541 sectors (2.5 GiB)

Number  Start (sector)    End (sector)  Size       Code  Name
   1            2048         2099199   1024.0 MiB  8300  Linux filesystem
   2         2099200         5171199   1.5 GiB     8300  Linux filesystem
```

2.4. Если вас устраивает текущее разбиение на разделы, нажмите `w`, чтобы записать изменения на диск и зафиксировать. Это дает предупреждение, после которого новая таблица разделов записывается в таблицу разделов **GUID**.
```console
Command (? for help): w

Final checks complete. About to write GPT data. THIS WILL OVERWRITE EXISTING
PARTITIONS!!

Do you want to proceed? (Y/N): Y
OK; writing new GUID partition table (GPT) to /dev/sdb.
The operation has completed successfully.
```

2.5. Если на этом этапе вы получите сообщение об ошибке, указывающее, что таблица разделов уже используется, введите `partprobe`, чтобы обновить таблицу разделов ядра.

2.6. Проверьте наличие нового раздела с помощью комманды `lsblk`
```bash
NAME                     MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS
sda                        8:0    0    20G  0 disk
├─sda1                     8:1    0     1M  0 part
├─sda2                     8:2    0     1G  0 part /boot
└─sda3                     8:3    0  18,4G  0 part
  ├─fedora-root 253:0    0    10G  0 lvm  /
  ├─fedora-swap 253:1    0     1G  0 lvm  [SWAP]
  ├─fedora-srv  253:2    0     1G  0 lvm  /srv
  ├─fedora-tmp  253:3    0   400M  0 lvm  /tmp
  ├─fedora-home 253:4    0     1G  0 lvm  /home
  └─fedora-var  253:5    0     5G  0 lvm  /var
sdb                        8:16   0     5G  0 disk
├─sdb1                     8:17   0     1G  0 part
└─sdb2                     8:18   0   1,5G  0 part
sr0                       11:0    1 665,1M  0 rom
zram0                    252:0    0   3,8G  0 disk [SWAP]
```

---
3. Создание разделов с помощью parted

3.1. Запустите интерактивную оболочку `parted`.
```bash
sudo parted /dev/sdb
```

3.2. Введите `help`, чтобы получить обзор доступных команд.

3.3. Введите `print`. Вы увидите сообщение о содержимом диска.

```console
Модель: VMware Virtual disk (scsi)
Диск /dev/sdb: 5369MB
Размер сектора (логич./физич.): 512B/512B
Таблица разделов: gpt
Флаги диска:

Номер  Начало  Конец   Размер  Файловая система  Имя               Флаги
 1     1049kB  1075MB  1074MB                    Linux filesystem
 2     1075MB  2648MB  1573MB                    Linux filesystem
```

3.4. Введите `mkpart`. Утилита запрашивает имя раздела. Введите `part3` (название раздела не имеет значения).

3.5. Теперь утилита запрашивает тип файловой системы. Это очень запутанный вариант, потому что он предполагает, что вы устанавливаете здесь тип файловой системы, но это не так. Кроме того, при использовании авто завершения **Tab** вы увидите список файловых систем, которые вы, вероятно, никогда раньше не использовали. Фактически, вы можете просто нажать **Enter**, чтобы принять вариант **ext2** по умолчанию, поскольку этот параметр в любом случае не используется, но я предлагаю использовать тип файловой системы, близкий к тому, что вы собираетесь использовать в разделе. Поэтому введите **xfs** и нажмите **Enter**, чтобы продолжить.

3.6. Теперь вам будет предложено указать начальное местоположение. Вы можете указать начальное положение как количество блоков или смещение от начала устройства. Обратите внимание, что вы можете ввести **1M**, чтобы указать начало раздела с **1** мегабайт, или введите **1 MiB**, чтобы он начинался с **1 MiB**. Это сбивает с толку, поэтому убедитесь, что вы указали здесь подходящее значение. На этом этапе введите **2648MB** и нажмите **Enter**.

3.7. Введите **4650MB**, чтобы указать конец раздела. После этого введите **print**, чтобы распечатать текущую таблицу разделов, и введите **quit**, чтобы выйти из утилиты и зафиксировать изменения.
```console
(parted) mkpart
Имя раздела?  []? part3
Тип файловой системы?  [ext2]? xfs
Начало?
Начало? 2648MB
Конец? 4648MB
```

```console
(parted) print
Модель: VMware Virtual disk (scsi)
Диск /dev/sdb: 5369MB
Размер сектора (логич./физич.): 512B/512B
Таблица разделов: gpt
Флаги диска:

Номер  Начало  Конец   Размер  Файловая система  Имя               Флаги
 1     1049kB  1075MB  1074MB                    Linux filesystem
 2     1075MB  2648MB  1573MB                    Linux filesystem
 3     2648MB  4648MB  2001MB  xfs               part3

(parted) quit
Информация: Не забудьте обновить /etc/fstab.
```

3.8. Проверьте наличие нового раздела с помощью комманды `lsblk`