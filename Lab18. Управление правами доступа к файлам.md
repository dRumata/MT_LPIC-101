## Практическая работа 18. 
## Управление правами доступа к файлам.

> Соответствие LPI101: (104.4 Manage file permissions and ownership)

### Вопросы для самопроверки

1. Какими будут разрешения по умолчанию для файла, если значение **umask** установлено в **027**?

<details>
    <summary>Вариант ответа</summary>
    
Разрешения будут **rw-r-----**

</details>
<br>

2. Предположим, что файл с именем **test.sh** является сценарием оболочки со следующими правами доступа и владения:
```console
-rwxr-sr-x 1 carol root 33 Dec 11 10:36 test.sh
```
- Каковы права доступа для владельца файла?
<details>
    <summary>Вариант ответа</summary>
    
Разрешения для владельца (2-4-й символы в выводе `ls -l`) - **rwx**, поэтому ответ: "читать, записывать и исполнять файл".

</details>
<br>

- Используя восьмеричную нотацию, каким должен быть синтаксис команды `chmod`, чтобы "снять" специальное разрешение, предоставленное этому файлу?

<details>
    <summary>Вариант ответа</summary>
Мы можем "снять" специальные разрешения, передав в команду `chmod` 4-ю цифру, **0**. Текущие разрешения равны **755**, поэтому команда должна быть 

```sh
chmod 0755
```
</details>
<br>


3. Рассмотрим этот файл:
```sh
$ ls -l /dev/sdb1
brw-rw---- 1 root disk 8, 17 Dec 21 18:51 /dev/sdb1
```
К какому типу относится файл **sdb1**? Кто может производить в него запись?
<details>
    <summary>Вариант ответа</summary>
Первый символ в выводе `ls -l` показывает тип файла. `b` - блочное устройство, обычно диск (внутренний или внешний), подключенный к машине. На него могут писать владелец (**root**) и все пользователи группы **disk**.
</details>
<br>

4. Рассмотрим следующие 4 файла:
```console
drwxr-xr-t 2 carol carol 4,0K Dec 20 18:46 Another_Directory
----r--r-- 1 carol carol 0 Dec 11 10:55 foo.bar
-rw-rw-r-- 1 carol carol 1,2G Dec 20 18:22 HugeFile.zip
drwxr-sr-x 2 carol users 4,0K Jan 18 17:26 Sample_Directory
```
Запишите соответствующие разрешения для каждого файла и каталога в восьмеричном режиме с использованием 4-значной нотации.

<details>
    <summary>Вариант ответа</summary>
Соответствующие разрешения в восьмеричном виде выглядят следующим образом:

```
Another_Directory 1755
``` 

**1** - sticky bit, **755** - обычные разрешения (**rwx** для пользователя, **r-x** для группы и других).

```
foo.bar 0044
```
Отсутствуют специальные разрешения (поэтому первая цифра равна **0**), отсутствие разрешений для пользователя (**---**) и только чтение (**r-r--**) для группы и других.

```
HugeFile.zip 0664
```

Специальных прав нет, поэтому первая цифра равна **0**. **6** (**rw-**) для пользователя и группы, **4** (**r--**) для остальных.

```
Sample_Directory 2755
``` 
**2** - для бита **SGID**, **7** (**rwx**) - для пользователя, **5** (**r-x**) - для группы и другие.

---
</details>


<br>

5. Рассмотрим права доступа к временному каталогу **/tmp** в системе Linux:

```sh
$ ls -l /tmp
drwxrwxrwt 19 root root 16K Dec 21 18:58 tmp
```
**user**, **group** и **others** имеют полные права. Но может ли обычный пользователь удалить какие-либо файлы из этого каталога? Почему так происходит?

<details>
    <summary>Вариант ответа</summary>

Каталог **/tmp** является каталогом с возможностью записи, то есть любой пользователь может писать в него. Но мы не хотим, чтобы один пользователь вмешивался в файлы, созданные другими, поэтому в каталоге установлен "липкий" бит (на что указывает буква `t` в разрешении для других). Это означает, что пользователь может удалять файлы в каталоге **/tmp**, но только те, которые созданы им самим.
</details>
<br>

6. Файл с именем **test.sh** имеет следующие разрешения: `-rwsr-xr-x`, то есть установлен бит **SUID**.
Теперь выполните следующие команды:
```sh
$ chmod u-x test.sh
$ ls -l test.sh
-rwSr-xr-x 1 carol carol 33 Dec 11 10:36 test.sh
```
Что мы сделали? Что означает заглавная буква `S`?

<details>
    <summary>Вариант ответа</summary>
Мы удалили права на выполнение для пользователя, которому принадлежит файл. Символ `s` (или `t`) занимает место символа `x` в выводе команды `ls -l`, поэтому системе нужно как-то показать, есть ли у пользователя права на выполнение или нет. Для этого нужно изменить регистр специального символа.
Строчная буква `s` в первой группе разрешений означает, что пользователь, которому принадлежит файл, имеет права на выполнение и что установлен бит **SUID**. Прописная `S` означает, что пользователь, владеющий файлом, не имеет `-` прав на выполнение и бит **SUID** установлен.
То же самое можно сказать и о **SGID**: строчная буква `s` во второй группе разрешений означает, что группа, которой принадлежит файл, имеет права на выполнение и что бит **SGID** установлен. Прописная S означает, что группа, владеющая файлом, не имеет `-` прав на выполнение и бит **SGID** установлен.
Это также справедливо и для бита **sticky**, представленного буквой `t` в третьей группе разрешений. Строчная буква `t` означает, что липкий бит установлен и что другие имеют права на выполнение. Прописная `T` означает, что липкий бит установлен и что у других нет прав на выполнение.
</details>
<br>



---
### Практические задания
1. Создайте пустой файл с именем **emptyfile** командой `touch emptyfile`. 

1.1 Теперь "обнулите" права доступа к файлу командой `chmod 000 emptyfile`. 

1.2 Вспомните, что мы "обнулили" права доступа для **emptyfile**. Таким образом, его начальное состояние будет таким:

```console
---------- 1 carol carol 0 Dec 11 10:55 emptyfile
```

1.3 Теперь выполните первую команду, `chmod 4 emptyfile`:

```sh
chmod 4 emptyfile
ls -l emptyfile

-------r-- 1 carol carol 0 Dec 11 10:55 emptyfile
```

1.4 Введите две цифры, как в `chmod 44 emptyfile`
```sh
$ chmod 44 emptyfile
$ ls -l emptyfile
----r--r-- 1 carol carol 0 Dec 11 10:55 emptyfile
```

Теперь были изменены права доступа для **group** и **others**. Из этого можно сделать вывод, что в восьмеричном режиме `chmod` считывает значение "задом наперед", от младшего разряда **others** к старшему **user**. Если передается одна цифра, то изменяются права для **others**. При передаче двух цифр изменяется **group** и **others**, при передаче трех - **user**, **group** и **others**, а при передаче четырех цифр - **user**, **group**, **others** и **специальные разрешения**.


---
2. Создайте пустой файл с именем **emptyfile** командой `touch emptyfile`. Теперь, используя `chmod` в символьном режиме, добавьте права на выполнение для владельца файла **emptyfile** и снимите права на запись и выполнение для всех остальных. Для этого используется только одна команда `chmod`.


2.1 Чтобы объединить эти два набора разрешений, мы добавляем между ними запятую. Таким образом, итоговый результат таков:
```sh
chmod u+x,go-wx emptyfile
```
Подумайте об этом следующим образом:
- "Для пользователя, владеющего файлом `u`, добавить `+` права на выполнение `x`", поэтому `u+x`.
- "Для группы `g` и других пользователей `o` снимите `-` разрешения на запись `w` и выполнение `x`", так что `go-wx`.

---
3. Как создать каталог с именем **Box**, в котором все файлы автоматически принадлежат группе **users** и могут быть удалены только создавшим их пользователем?

3.1 Первый шаг - создание каталога:
```sh
$ mkdir Box
```
3.2 Мы хотим, чтобы каждый файл, созданный в этом каталоге, автоматически присваивался группе **users**. Сделайте это, установив данную группу в качестве владельца каталога, а затем установив для нее бит **SGID**. Нам также необходимо убедиться, что любой член группы может писать в этот каталог.
Поскольку нам не важны другие права доступа, а мы хотим "перекинуть" только специальные биты, имеет смысл использовать символьный режим:
```sh
$ chown :users Box/
$ chmod g+wxs Box/
```
Обратите внимание, что если ваш текущий пользователь не входит в группу **users**, то для выполнения изменений от имени **root** перед приведенными выше командами необходимо использовать команду sudo.

3.3 Убедитесь, что только пользователь, создавший файл, может его удалить. Это делается путем установки "липкого" бита (обозначается буквой `t`) на каталог. Помните, что он установлен на разрешениях для других `o`.
```sh 
$ chmod o+t Box/
```
3.4 Разрешения на каталог **Box** должны быть следующими:
```console
drwxrwsr-t 2 carol users 4,0K Jan 18 19:09 Box
```
3.5 Можно указать **SGID** и **sticky**-бит, используя только одну команду `chmod`:
```sh
$ chmod g+wxs,o+t Box/
```
---
4. Управление основными разрешениями 

4.1. Создайте два каталога `/data/sales` и `/data/account`
```bash
mkdir -p /data/sales /data/account
```

4.2. Перед установкой разрешений измените владельцев этих каталогов с помощью `chown` 
```bash
chown  linda.sales /data/sales
chown linda.account /data/account
```

4.3. Установите разрешения, чтобы позволить владельцам пользователей и групп записывать файлы в эти каталоги и запретить доступ всем остальным: 
```bash
chmod 770 /data/sales 
```
а затем 

```bash
chmod 770 /data/account
```

4.4. Используйте `su - laura`, чтобы стать пользователем **laura**, и перейдите в каталог `/data/account`. Используйте `touch emptyfile`, чтобы создать файл в этом каталоге. Это работает? 

4.5. Все еще как пользователь **laura**, выполните `cd /data/sales` и `touch emptyfile`, чтобы создать файл в этом каталоге. Это работает?

4.6. Просмотрите структуру директорий в каталоге /data
```bash
tree -ughL 2 /data --du
```

---
5. Работа со специальными разрешениями

5.1 Откройте терминал, в котором вы являетесь пользователем **linda**.

5.2 Перейдите в каталог `/data/sales`.

5.3  Cоздайте два файла **linda1** и **linda2**, владельцем которых является **linda**. Используйте для создания файлов команду `touch`

5.4 Введите `exit`, чтобы вернуться в корневую оболочку, а затем используйте `su - laura`, чтобы переключить текущую идентификацию пользователя на пользователя **laura**, который также является членом группы **sales**. 

5.5 Снова используйте `cd /data/sales`, находясь в этом каталоге выполните `ls -l`. Вы увидите два файла, которые были созданы пользователем linda и принадлежат группе linda. Используйте `rm -f linda*`. Это удалит оба файла.

5.6 Используйте команды `touch laura1 laura2` для создания двух файлов, принадлежащих пользователю laura. 

5.7 Используйте `sudo su -` для повышения ваших текущих разрешений до пользователя **root**. 

5.8 Установите бит идентификатора группы, а также **sticky bit** в общем каталоге группы
```bash
chmod g+s,o+t /data/sales
```

5.9  Переключитесь в пользователя  **linda** `su - linda` и перейдите в каталог `/data/sales`.

5.10 Создайте два файла `touch linda3 linda4`. Теперь вы должны увидеть, что два созданных вами файла принадлежат группе **sales**, которая является владельцем группы каталога `/data/sales`. 

5.11 Используйте команду `rm -rd laura*`. Обычно **sticky bit** мешает вам сделать это, но поскольку Линда является владельцем каталога, содержащего файлы, вам все равно разрешено это сделать!

---
6. Управление расширенными разрешениями с помощью списков контроля доступа
6.1 Откройте **root**-терминал.
    
6.2 Предоставьте группе **account** разрешения на чтение в каталоге `/data/sales`
```bash
setfacl -m g:account:rx /data/sales
```

6.3 Предоставьте группе **sales** права на чтение для каталога `/data/account`.
```bash
setfacl -mg:sales:rx /data/account
```

6.4 Воспользуйтесь командой `getfacl /data/`, чтобы убедиться, что разрешения были установлены так, как вы намеревались. 
    
6.5 Установите **ACL** по умолчанию для каталога **sales**.
```bash
setfacl -m d:g:account:rx,g:sales:rwx /data/sales
``` 

6.6 Добавьте **ACL** по умолчанию для каталога `/data/account`
```bash
setfacl -m d:g:sales:rx,g:account:rwx /data/account
```

6.7 Убедитесь, что настройки **ACL** действуют, добавив новый файл в `/data/sales`. Чтобы проверить текущие назначения разрешений: 
```bash
touch /data/sales/newfile
getfacl /data/sales/newfile
```